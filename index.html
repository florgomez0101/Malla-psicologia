<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Malla Curricular Psicología</title>
<style>
  @font-face {
    font-family: 'Perfect Penmanship';
    src: url('KGPerfectPenmanship.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
  :root {
    --color-fondo-general: #fffde7; /* amarillo pastel */
    --color-fondo-anos: #dbe9f4; /* celeste pastel suave */
    --color-fondo-bloques: #dbe9f4; /* celeste pastel suave igual años */
    --color-aprobada: #c8f7c5;
    --color-regular: #f8bbd0;
    --color-libre: #e1bee7;
    --color-cursable: #ffe0b2;
    --color-bloqueada: #e0e0e0;
  }

  body {
    font-family: 'Perfect Penmanship', 'Segoe UI', sans-serif;
    background-color: var(--color-fondo-general);
    color: #333;
    margin: 0;
    padding: 1rem;
  }
  h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 1rem;
  }
  /* Panel de configuración */
  #panel-colores {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    padding: 0.8rem 1rem;
    margin-bottom: 1.5rem;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-family: Arial, sans-serif;
    font-size: 0.9rem;
  }
  #panel-colores label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
  }
  #panel-colores input[type=color] {
    width: 32px;
    height: 24px;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  /* Malla en flex: años como columnas */
  #malla {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
  }
  .year {
    background-color: var(--color-fondo-anos);
    border-radius: 10px;
    padding: 0.8rem;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    min-width: 240px;
    display: flex;
    flex-direction: column;
  }
  .year h3 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 0.8rem;
  }
  /* Bloques (Anual, Semestres) apilados vertical */
  .bloques {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .bloque {
    background-color: var(--color-fondo-bloques);
    border-radius: 8px;
    padding: 0.5rem 0.6rem;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
  }
  .bloque h4 {
    margin: 0 0 0.5rem 0.5rem;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }
  /* Materias en columnas verticales (filas por materias) */
  .subject {
    background-color: var(--color-libre);
    border-radius: 8px;
    padding: 0.4rem 0.6rem;
    margin: 0.2rem 0.4rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-family: 'Perfect Penmanship', cursive;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .subject.estado-aprobada {
    background-color: var(--color-aprobada);
  }
  .subject.estado-regular {
    background-color: var(--color-regular);
  }
  .subject.estado-cursable {
    background-color: var(--color-cursable);
  }
  .subject.estado-libre {
    background-color: var(--color-libre);
  }
  .subject.bloqueada {
    background-color: var(--color-bloqueada);
    cursor: not-allowed;
    color: #777;
  }
  /* Estilo input nota */
  .nota-input {
    width: 38px;
    font-size: 0.85rem;
    font-family: Arial, sans-serif;
    border-radius: 4px;
    border: 1px solid #aaa;
    text-align: center;
    margin-left: 0.6rem;
  }
  /* Scroll horizontal para malla si no cabe */
  @media (max-width: 768px) {
    #malla {
      flex-wrap: nowrap;
    }
  }
</style>
</head>
<body>

<h2>Malla Curricular - Licenciatura en Psicología</h2>

<!-- Panel para elegir colores -->
<div id="panel-colores" aria-label="Configuración de colores">
  <label for="color-fondo-general">Fondo general
    <input type="color" id="color-fondo-general" value="#fffde7" title="Fondo general de la página" />
  </label>
  <label for="color-fondo-anos">Fondo años
    <input type="color" id="color-fondo-anos" value="#dbe9f4" title="Fondo de los años (columnas)" />
  </label>
  <label for="color-fondo-bloques">Fondo bloques
    <input type="color" id="color-fondo-bloques" value="#dbe9f4" title="Fondo de los bloques (Anual, Semestres)" />
  </label>
  <label for="color-aprobada">Estado aprobada
    <input type="color" id="color-aprobada" value="#c8f7c5" title="Color para materias aprobadas" />
  </label>
  <label for="color-regular">Estado regular
    <input type="color" id="color-regular" value="#f8bbd0" title="Color para materias regulares" />
  </label>
  <label for="color-cursable">Estado cursable
    <input type="color" id="color-cursable" value="#ffe0b2" title="Color para materias cursables" />
  </label>
  <label for="color-libre">Estado libre
    <input type="color" id="color-libre" value="#e1bee7" title="Color para materias libres" />
  </label>
  <label for="color-bloqueada">Estado bloqueada
    <input type="color" id="color-bloqueada" value="#e0e0e0" title="Color para materias bloqueadas" />
  </label>
</div>

<!-- Contenedor malla -->
<div id="malla" role="table" aria-label="Malla curricular"></div>

<script>
  const ESTADOS = ['libre', 'cursable', 'regular', 'aprobada'];
  const defaultColors = {
    'color-fondo-general': '#fffde7',
    'color-fondo-anos': '#dbe9f4',
    'color-fondo-bloques': '#dbe9f4',
    'color-aprobada': '#c8f7c5',
    'color-regular': '#f8bbd0',
    'color-cursable': '#ffe0b2',
    'color-libre': '#e1bee7',
    'color-bloqueada': '#e0e0e0',
  };

  // Cargar colores guardados o defaults
  function cargarColores() {
    for (const key in defaultColors) {
      const color = localStorage.getItem(key) || defaultColors[key];
      document.getElementById(key).value = color;
      document.documentElement.style.setProperty(`--${key.replace('color-', 'color-')}`, color);
    }
  }

  // Guardar y aplicar color
  function cambiarColor(e) {
    const id = e.target.id;
    const val = e.target.value;
    localStorage.setItem(id, val);
    document.documentElement.style.setProperty(`--${id.replace('color-', 'color-')}`, val);
  }

  // Añadir listeners a inputs de color
  function initPanelColores() {
    for (const key in defaultColors) {
      const input = document.getElementById(key);
      input.addEventListener('input', cambiarColor);
    }
  }

  // Datos materias (igual que antes)
  const materias = {
    "1": {
      "Anual": [
        {nombre: "Filosofía I", clave: "filo1", requisitos: [], regularidad: []},
        {nombre: "Historia de la Psicología", clave: "histpsi", requisitos: [], regularidad: []},
        {nombre: "Metodología de la Investigación en Psicología I", clave: "metod1", requisitos: [], regularidad: []},
        {nombre: "Neuropsicología", clave: "neuro", requisitos: [], regularidad: []}
      ],
      "1º Semestre": [
        {nombre: "Psicología General", clave: "psigral", requisitos: [], regularidad: []},
        {nombre: "Historia del Pensamiento Sociopolítico", clave: "histpol", requisitos: [], regularidad: []}
      ],
      "2º Semestre": [
        {nombre: "Antropología Cultural", clave: "antro", requisitos: ["histpol"], regularidad: ["histpol"]},
        {nombre: "Lingüística", clave: "linguistica", requisitos: [], regularidad: []}
      ]
    },
    // ... (aquí irían los demás años igual que antes, para abreviar lo dejo omitido)
  };

  function getEstado(clave) {
    return localStorage.getItem('estado_' + clave) || 'libre';
  }
  function setEstado(clave, estado) {
    localStorage.setItem('estado_' + clave, estado);
    renderMalla();
  }

  // Nota guardada para una materia
  function getNota(clave) {
    return localStorage.getItem('nota_' + clave) || '';
  }
  function setNota(clave, nota) {
    if(nota === '' || (Number(nota) >= 0 && Number(nota) <= 10)){
      localStorage.setItem('nota_' + clave, nota);
    }
  }

  // Chequea si tiene regularidad para cursar
  function cumpleRegularidad(reqs) {
    return reqs.every(clave => {
      const estado = getEstado(clave);
      return estado === 'regular' || estado === 'aprobada';
    });
  }

  // Chequea si tiene requisitos para finalizar
  function cumpleFinalizacion(reqs) {
    return reqs.every(clave => getEstado(clave) === 'aprobada');
  }

  function renderMalla() {
    const cont = document.getElementById('malla');
    cont.innerHTML = '';

    // Ordenar años
    const anios = Object.keys(materias).sort((a,b) => a-b);

    anios.forEach(anio => {
      const yearDiv = document.createElement('section');
      yearDiv.className = 'year';
      yearDiv.setAttribute('role','grid');
      yearDiv.setAttribute('aria-label', `${anio}° Año`);
      yearDiv.innerHTML = `<h3>${anio}° Año</h3>`;

      const bloquesDiv = document.createElement('div');
      bloquesDiv.className = 'bloques';

      ['Anual', '1º Semestre', '2º Semestre'].forEach(bloqueName => {
        if(!materias[anio][bloqueName]) return;
        const bloqueDiv = document.createElement('div');
        bloqueDiv.className = 'bloque';
        bloqueDiv.setAttribute('role','rowgroup');

        const titulo = document.createElement('h4');
        titulo.textContent = bloqueName;
        bloqueDiv.appendChild(titulo);

        materias[anio][bloqueName].forEach(mat => {
          let estado = getEstado(mat.clave);
          let claseEstado = 'estado-' + estado;
          let tooltip = '';
          let puedeCursar = cumpleRegularidad(mat.regularidad);
          let puedeFinalizar = cumpleFinalizacion(mat.requisitos);

          if(!puedeCursar) {
            claseEstado = 'bloqueada';
            const faltan = mat.regularidad.filter(k => !['regular','aprobada'].includes(getEstado(k)));
            tooltip = 'Falta regularidad en:\n' + faltan.join(', ');
          } else if(estado === 'libre' && puedeCursar && !puedeFinalizar) {
            claseEstado = 'estado-cursable';
            tooltip = 'Habilitada para cursar, pero no para rendir final';
          }

          const matDiv = document.createElement('div');
          matDiv.className = `subject ${claseEstado}`;
          matDiv.setAttribute('role','gridcell');
          matDiv.setAttribute('tabindex','0');
          matDiv.setAttribute('title', tooltip || mat.nombre);

          // Nombre materia en span
          const nombreSpan = document.createElement('span');
          nombreSpan.textContent = mat.nombre;
          matDiv.appendChild(nombreSpan);

          // Input nota
          const inputNota = document.createElement('input');
          inputNota.type = 'number';
          inputNota.className = 'nota-input';
          inputNota.min = '0';
          inputNota.max = '10';
          inputNota.step = '0.1';
          inputNota.value = getNota(mat.clave);
          inputNota.title = 'Ingrese nota de 0 a 10';
          inputNota.disabled = claseEstado === 'bloqueada';
          inputNota.addEventListener('click', e => e.stopPropagation()); // evitar cambiar estado al click input
          inputNota.addEventListener('keydown', e => e.stopPropagation());
          inputNota.addEventListener('change', e => {
            let val = e.target.value.trim();
            if(val === '') {
              setNota(mat.clave, '');
              return;
            }
            let num = Number(val);
            if(isNaN(num) || num < 0 || num > 10){
              alert('Ingrese una nota válida entre 0 y 10');
              e.target.value = getNota(mat.clave);
            } else {
              setNota(mat.clave, num.toFixed(1));
            }
          });
          matDiv.appendChild(inputNota);

          if(claseEstado !== 'bloqueada'){
            matDiv.onclick = () => {
              // Ciclo de estados: libre -> cursable -> regular -> aprobada -> libre
              const actual = getEstado(mat.clave);
              let nuevo;
              switch(actual){
                case 'libre': nuevo = 'cursable'; break;
                case 'cursable': nuevo = 'regular'; break;
                case 'regular': nuevo = 'aprobada'; break;
                case 'aprobada': nuevo = 'libre'; break;
                default: nuevo = 'libre';
              }
              setEstado(mat.clave, nuevo);
            };
            // Soporte teclado: Enter o espacio cambia estado
            matDiv.onkeydown = e => {
              if(e.key === 'Enter' || e.key === ' '){
                e.preventDefault();
                matDiv.click();
              }
            };
          }

          bloqueDiv.appendChild(matDiv);
        });

        bloquesDiv.appendChild(bloqueDiv);
      });

      yearDiv.appendChild(bloquesDiv);
      cont.appendChild(yearDiv);
    });
  }

  // Inicializar colores guardados y listeners
  cargarColores();
  initPanelColores();
  renderMalla();
</script>

</body>
</html>

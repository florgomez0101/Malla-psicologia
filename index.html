<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Malla Curricular Psicología - Completo</title>

<style>
  @font-face {
    font-family: 'Perfect Penmanship';
    src: url('KGPerfectPenmanship.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }

  :root {
    --color-fondo-general: #fffde7;
    --color-fondo-anos: #dbe9f4;
    --color-fondo-bloques: #dbe9f4;
    --color-aprobada: #c8f7c5;
    --color-regular: #f8bbd0;
    --color-libre: #e1bee7;
    --color-cursable: #ffe0b2;
    --color-bloqueada: #e0e0e0;

    --color-borde: #999999;
    --color-borde-bloqueada: #999999;
    --color-letra: #333333;
  }

  /* Reset y básicos */
  body {
    font-family: 'Perfect Penmanship', 'Segoe UI', sans-serif;
    background-color: var(--color-fondo-general);
    color: var(--color-letra);
    margin: 0;
    padding: 1rem;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 1rem;
  }

  /* Botón hamburguesa para panel colores */
  #btn-menu {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 32px;
    height: 24px;
    cursor: pointer;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  #btn-menu span {
    display: block;
    height: 4px;
    background: var(--color-letra);
    border-radius: 2px;
  }
  #btn-menu:focus {
    outline: 2px solid #555;
  }

  /* Panel de configuración colores */
  #panel-colores {
    position: fixed;
    top: 3.5rem;
    right: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(0,0,0,0.15);
    padding: 1rem 1.2rem;
    max-width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    font-family: Arial, sans-serif;
    font-size: 0.9rem;
    display: none;
    z-index: 999;
  }
  #panel-colores.visible {
    display: block;
  }
  #panel-colores label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
    cursor: pointer;
  }
  #panel-colores input[type=color] {
    width: 32px;
    height: 24px;
    border: none;
    padding: 0;
    cursor: pointer;
    border-radius: 4px;
  }
  #panel-colores h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-weight: bold;
  }

  /* Malla curricular flex años */
  #malla {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
  }
  .year {
    background-color: var(--color-fondo-anos);
    border-radius: 10px;
    padding: 0.8rem;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    min-width: 260px;
    display: flex;
    flex-direction: column;
  }
  .year h3 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 0.8rem;
    font-family: Arial, sans-serif;
  }

  /* Bloques verticales */
  .bloques {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .bloque {
    background-color: var(--color-fondo-bloques);
    border-radius: 8px;
    padding: 0.5rem 0.6rem;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
  }
  .bloque h4 {
    margin: 0 0 0.5rem 0.5rem;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }

  /* Materias */
  .subject {
    background-color: var(--color-libre);
    border-radius: 8px;
    padding: 0.4rem 0.6rem;
    margin: 0.2rem 0.4rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-family: 'Perfect Penmanship', cursive;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.15s ease;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 2px solid var(--color-borde);
  }

  /* Animación clic */
  .subject:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
  }

  /* Estados */
  .estado-aprobada {
    background-color: var(--color-aprobada);
    color: #2a4d24;
    text-decoration: line-through;
    opacity: 0.7;
  }
  .estado-regular {
    background-color: var(--color-regular);
  }
  .estado-cursable {
    background-color: var(--color-cursable);
  }
  .estado-libre {
    background-color: var(--color-libre);
  }
  .bloqueada {
    background-color: var(--color-bloqueada);
    cursor: not-allowed;
    color: #777;
    border-style: dashed;
    border-color: var(--color-borde-bloqueada);
  }

  /* Input nota */
  .nota-input {
    width: 38px;
    font-size: 0.85rem;
    font-family: Arial, sans-serif;
    border-radius: 4px;
    border: 1px solid #aaa;
    text-align: center;
    margin-left: 0.6rem;
  }
  .nota-input:disabled {
    background-color: #ddd;
    cursor: not-allowed;
  }

  /* Scroll horizontal para pantallas chicas */
  @media (max-width: 768px) {
    #malla {
      flex-wrap: nowrap;
    }
  }
</style>
</head>
<body>

<h2>Malla Curricular - Licenciatura en Psicología</h2>

<!-- Botón hamburguesa para panel colores -->
<div id="btn-menu" tabindex="0" aria-label="Abrir panel de configuración de colores" role="button" aria-pressed="false">
  <span></span><span></span><span></span>
</div>

<!-- Panel para elegir colores -->
<div id="panel-colores" aria-label="Configuración de colores" role="region" aria-hidden="true">
  <h3>Configuración de Colores</h3>
  <label for="color-fondo-general">Fondo general
    <input type="color" id="color-fondo-general" value="#fffde7" title="Fondo general de la página" />
  </label>
  <label for="color-fondo-anos">Fondo años
    <input type="color" id="color-fondo-anos" value="#dbe9f4" title="Fondo de los años (columnas)" />
  </label>
  <label for="color-fondo-bloques">Fondo bloques
    <input type="color" id="color-fondo-bloques" value="#dbe9f4" title="Fondo de los bloques (Anual, Semestres)" />
  </label>
  <label for="color-aprobada">Estado aprobada
    <input type="color" id="color-aprobada" value="#c8f7c5" title="Color para materias aprobadas" />
  </label>
  <label for="color-regular">Estado regular
    <input type="color" id="color-regular" value="#f8bbd0" title="Color para materias regulares" />
  </label>
  <label for="color-cursable">Estado cursable
    <input type="color" id="color-cursable" value="#ffe0b2" title="Color para materias cursables" />
  </label>
  <label for="color-libre">Estado libre
    <input type="color" id="color-libre" value="#e1bee7" title="Color para materias libres" />
  </label>
  <label for="color-bloqueada">Estado bloqueada
    <input type="color" id="color-bloqueada" value="#e0e0e0" title="Color para materias bloqueadas" />
  </label>
  <label for="color-borde">Color bordes
    <input type="color" id="color-borde" value="#999999" title="Color de los bordes de materias" />
  </label>
  <label for="color-borde-bloqueada">Color borde bloqueada
    <input type="color" id="color-borde-bloqueada" value="#999999" title="Color de borde para materias bloqueadas" />
  </label>
  <label for="color-letra">Color letras
    <input type="color" id="color-letra" value="#333333" title="Color del texto en materias y página" />
  </label>
</div>

<!-- Contenedor malla -->
<div id="malla" role="table" aria-label="Malla curricular"></div>

<script>
  const defaultColors = {
    'color-fondo-general': '#fffde7',
    'color-fondo-anos': '#dbe9f4',
    'color-fondo-bloques': '#dbe9f4',
    'color-aprobada': '#c8f7c5',
    'color-regular': '#f8bbd0',
    'color-cursable': '#ffe0b2',
    'color-libre': '#e1bee7',
    'color-bloqueada': '#e0e0e0',
    'color-borde': '#999999',
    'color-borde-bloqueada': '#999999',
    'color-letra': '#333333'
  };

  // Todas las materias completas, con correlativas y condiciones según lo enviado:
  const materias = {
    "1": {
      "Anual": [
        {nombre: "Filosofía I", clave: "filo1", requisitos: [], regularidad: []},
        {nombre: "Historia de la Psicología", clave: "histpsi", requisitos: [], regularidad: []},
        {nombre: "Metodología de la Investigación en Psicología I", clave: "metod1", requisitos: [], regularidad: []},
        {nombre: "Neuropsicología", clave: "neuro", requisitos: [], regularidad: []}
      ],
      "1º Semestre": [
        {nombre: "Psicología General", clave: "psigral", requisitos: [], regularidad: []},
        {nombre: "Historia del Pensamiento Sociopolítico", clave: "histpol", requisitos: [], regularidad: []}
      ],
      "2º Semestre": [
        {nombre: "Antropología Cultural", clave: "antro", requisitos: ["histpol"], regularidad: ["histpol"]},
        {nombre: "Lingüística", clave: "linguistica", requisitos: [], regularidad: []}
      ]
    },
    "2": {
      "Anual": [
        {nombre: "Metodología de la Investigación en Psicología II", clave: "metod2", requisitos: ["metod1"], regularidad: ["metod1"]},
        {nombre: "Psicología del Desarrollo", clave: "psides", requisitos: ["psigral"], regularidad: ["psigral"]}
      ],
      "1º Semestre": [
        {nombre: "Psicología Social", clave: "psisocial", requisitos: ["psigral"], regularidad: ["psigral"]},
        {nombre: "Psicología de la Personalidad", clave: "psipersonal", requisitos: ["psigral"], regularidad: ["psigral"]},
        {nombre: "Neurofisiología", clave: "neurofisiol", requisitos: ["neuro"], regularidad: ["neuro"]}
      ],
      "2º Semestre": [
        {nombre: "Psicología Experimental", clave: "psiexp", requisitos: ["metod1"], regularidad: ["metod1"]},
        {nombre: "Psicología Cognitiva", clave: "psicogn", requisitos: ["psigral"], regularidad: ["psigral"]},
        {nombre: "Estadística Aplicada", clave: "estadistica", requisitos: ["metod1"], regularidad: ["metod1"]}
      ]
    },
    "3": {
      "Anual": [
        {nombre: "Psicología Profesional", clave: "psiprof", requisitos: ["psiexp", "psicogn"], regularidad: ["psiexp", "psicogn"]},
        {nombre: "Psicopatología Infantil y Adolescente", clave: "psicopatinf", requisitos: ["psipersonal"], regularidad: ["psipersonal"]},
        {nombre: "Neuropsicología Clínica", clave: "neuroclin", requisitos: ["psiexp","neuro","psipersonal"], regularidad: ["neuro","psipersonal"]},
        {nombre: "Psicología Clínica I", clave: "psiclin1", requisitos: ["psipersonal","psicopatinf"], regularidad: ["psipersonal","psicopatinf"]},
        {nombre: "Psicología Comunitaria", clave: "psicocom", requisitos: ["psisocial"], regularidad: ["psisocial"]},
        {nombre: "Teoría Psicoanalítica", clave: "teopsicoan", requisitos: ["psiprof"], regularidad: ["psiprof"]}
      ]
    },
    "4": {
      "Anual": [
        {nombre: "Taller de Prácticas y Técnicas en Psicología Clínica", clave: "tallerclin", requisitos: ["psiclin1","teopsicoan"], regularidad: ["psiclin1","teopsicoan"]},
        {nombre: "Trabajo Integrador Final", clave: "trabintfinal", requisitos: [], regularidad: [], esTrabajoFinal: true}
      ],
      "1º Semestre": [
        {nombre: "Psicología Clínica II", clave: "psiclin2", requisitos: ["psiclin1"], regularidad: ["psiclin1"]},
        {nombre: "Psicología del Trabajo", clave: "psitrab", requisitos: ["psipersonal","psisocial"], regularidad: ["psipersonal","psisocial"]},
        {nombre: "Psicología Forense", clave: "psiforense", requisitos: ["psiclin1"], regularidad: ["psiclin1"]},
        {nombre: "Terapia Familiar y de Pareja", clave: "terapfamiliar", requisitos: ["psiclin1"], regularidad: ["psiclin1"]}
      ],
      "2º Semestre": [
        {nombre: "Prácticas Pre-Profesionales", clave: "pracprepro", requisitos: ["tallerclin","psiclin2","psitrab","psiforense","terapfamiliar"], regularidad: ["tallerclin","psiclin2","psitrab","psiforense","terapfamiliar"]}
      ]
    },
    "5": {
      "Anual": [
        {nombre: "Prácticas Pre-Profesionales", clave: "pracprepro5", requisitos: ["pracprepro"], regularidad: ["pracprepro"]}
      ],
      "1º Semestre": [
        {nombre: "Seminarios y Talleres", clave: "seminarios", requisitos: ["pracprepro5"], regularidad: ["pracprepro5"]}
      ],
      "2º Semestre": [
        {nombre: "Tesis", clave: "tesis", requisitos: ["seminarios"], regularidad: ["seminarios"]}
      ]
    }
  };

  // Guardar y obtener estado
  function getEstado(clave) {
    return localStorage.getItem('estado_' + clave) || 'libre';
  }
  function setEstado(clave, estado) {
    localStorage.setItem('estado_' + clave, estado);
    renderMalla();
  }

  // Guardar y obtener nota
  function getNota(clave) {
    return localStorage.getItem('nota_' + clave) || '';
  }
  function setNota(clave, nota) {
    if(nota === '' || (Number(nota) >= 0 && Number(nota) <= 10)){
      localStorage.setItem('nota_' + clave, nota);
    }
  }

  // Colores (carga y cambio)
  function cargarColores() {
    for (const key in defaultColors) {
      const color = localStorage.getItem(key) || defaultColors[key];
      const el = document.getElementById(key);
      if(el) el.value = color;
      document.documentElement.style.setProperty(`--${key}`, color);
    }
  }
  function cambiarColor(e) {
    const id = e.target.id;
    const val = e.target.value;
    localStorage.setItem(id, val);
    document.documentElement.style.setProperty(`--${id}`, val);
  }
  function initPanelColores() {
    for (const key in defaultColors) {
      const input = document.getElementById(key);
      if(input) input.addEventListener('input', cambiarColor);
    }
  }

  // Verifica que se cumplan regularidades para cursar
  function cumpleRegularidad(reqs) {
    return reqs.every(clave => {
      const estado = getEstado(clave);
      return estado === 'regular' || estado === 'aprobada';
    });
  }

  // Verifica que se cumplan requisitos para finalizar
  function cumpleFinalizacion(reqs) {
    return reqs.every(clave => getEstado(clave) === 'aprobada');
  }

  // Verifica si todas materias de 4to año están aprobadas para habilitar Trabajo Integrador Final
  function puedeCursarTrabajoFinal() {
    const cuarto = materias["4"];
    if (!cuarto) return false;
    let todasAprobadas = true;
    for (const bloque in cuarto) {
      for (const mat of cuarto[bloque]) {
        // Ignorar el mismo Trabajo Final
        if(mat.clave === 'trabintfinal') continue;
        if(getEstado(mat.clave) !== 'aprobada'){
          todasAprobadas = false;
          break;
        }
      }
      if(!todasAprobadas) break;
    }
    return todasAprobadas;
  }

  // Renderiza la malla curricular
  function renderMalla() {
    const cont = document.getElementById('malla');
    cont.innerHTML = '';

    const anios = Object.keys(materias).sort((a,b) => a-b);

    anios.forEach(anio => {
      const yearDiv = document.createElement('section');
      yearDiv.className = 'year';
      yearDiv.setAttribute('role','grid');
      yearDiv.setAttribute('aria-label', `${anio}° Año`);
      yearDiv.innerHTML = `<h3>${anio}° Año</h3>`;

      const bloquesDiv = document.createElement('div');
      bloquesDiv.className = 'bloques';

      ['Anual', '1º Semestre', '2º Semestre'].forEach(bloqueName => {
        if(!materias[anio][bloqueName]) return;
        const bloqueDiv = document.createElement('div');
        bloqueDiv.className = 'bloque';
        bloqueDiv.setAttribute('role','rowgroup');

        const titulo = document.createElement('h4');
        titulo.textContent = bloqueName;
        bloqueDiv.appendChild(titulo);

        materias[anio][bloqueName].forEach(mat => {
          let estado = getEstado(mat.clave);
          let claseEstado = 'estado-' + estado;
          let tooltip = '';
          let puedeCursar = cumpleRegularidad(mat.regularidad);
          let puedeFinalizar = cumpleFinalizacion(mat.requisitos);

          // Permitir marcar libre en cualquier materia: no bloquea
          // pero si no se cumple regularidad, se marca bloqueada (salvo libres)
          if(estado !== 'libre' && !puedeCursar) {
            claseEstado = 'bloqueada';
            tooltip = 'Falta regularidad en:\n' + mat.regularidad.filter(k => !['regular','aprobada'].includes(getEstado(k))).join(', ');
          }
          else if(estado === 'libre' && puedeCursar && !puedeFinalizar) {
            claseEstado = 'estado-cursable';
            tooltip = 'Habilitada para cursar, pero no para rendir final';
          }

          // Bloqueo especial Trabajo Integrador Final
          if(mat.clave === 'trabintfinal' && !puedeCursarTrabajoFinal()) {
            claseEstado = 'bloqueada';
            tooltip = 'Debe aprobarse todas las materias de 4° año para cursar esta materia.';
          }

          const matDiv = document.createElement('div');
          matDiv.className = `subject ${claseEstado}`;
          matDiv.setAttribute('role','gridcell');
          matDiv.setAttribute('tabindex', claseEstado === 'bloqueada' ? '-1' : '0');
          matDiv.setAttribute('title', tooltip || mat.nombre);
          matDiv.setAttribute('aria-disabled', claseEstado === 'bloqueada' ? 'true' : 'false');

          // Nombre materia
          const nombreSpan = document.createElement('span');
          nombreSpan.textContent = mat.nombre;
          matDiv.appendChild(nombreSpan);

          // Input nota
          const inputNota = document.createElement('input');
          inputNota.type = 'number';
          inputNota.className = 'nota-input';
          inputNota.min = '0';
          inputNota.max = '10';
          inputNota.step = '0.1';
          inputNota.value = getNota(mat.clave);
          inputNota.title = 'Ingrese nota de 0 a 10';
          inputNota.disabled = claseEstado === 'bloqueada';
          inputNota.setAttribute('aria-label', `Nota para ${mat.nombre}`);
          // Evitar que el click y teclas cambien estado de materia
          inputNota.addEventListener('click', e => e.stopPropagation());
          inputNota.addEventListener('keydown', e => e.stopPropagation());
          inputNota.addEventListener('change', e => {
            let val = e.target.value.trim();
            if(val === '') {
              setNota(mat.clave, '');
              return;
            }
            let num = Number(val);
            if(isNaN(num) || num < 0 || num > 10){
              alert('Ingrese una nota válida entre 0 y 10');
              e.target.value = getNota(mat.clave);
            } else {
              setNota(mat.clave, num.toFixed(1));
            }
          });
          matDiv.appendChild(inputNota);

          if(claseEstado !== 'bloqueada'){
            matDiv.onclick = () => {
              // Ciclo estados: libre -> cursable -> regular -> aprobada -> libre
              const actual = getEstado(mat.clave);
              let nuevo;
              switch(actual){
                case 'libre': nuevo = 'cursable'; break;
                case 'cursable': nuevo = 'regular'; break;
                case 'regular': nuevo = 'aprobada'; break;
                case 'aprobada': nuevo = 'libre'; break;
                default: nuevo = 'libre';
              }
              setEstado(mat.clave, nuevo);
            };
            matDiv.onkeydown = e => {
              if(e.key === 'Enter' || e.key === ' '){
                e.preventDefault();
                matDiv.click();
              }
            };
          }

          bloqueDiv.appendChild(matDiv);
        });

        bloquesDiv.appendChild(bloqueDiv);
      });

      yearDiv.appendChild(bloquesDiv);
      cont.appendChild(yearDiv);
    });
  }

  // Manejo botón menú panel colores
  const btnMenu = document.getElementById('btn-menu');
  const panelColores = document.getElementById('panel-colores');

  btnMenu.addEventListener('click', () => {
    const visible = panelColores.classList.toggle('visible');
    btnMenu.setAttribute('aria-pressed', visible ? 'true' : 'false');
    panelColores.setAttribute('aria-hidden', visible ? 'false' : 'true');
  });
  btnMenu.addEventListener('keydown', e => {
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      btnMenu.click();
    }
  });

  // Inicialización
  cargarColores();
  initPanelColores();
  renderMalla();
</script>

</body>
</html>

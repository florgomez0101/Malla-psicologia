<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Malla Curricular Psicología</title>
<style>
  @font-face {
    font-family: 'Perfect Penmanship';
    src: url('KGPerfectPenmanship.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }

  :root {
    --color-fondo-general: #fffde7; /* amarillo pastel */
    --color-fondo-anos: #dbe9f4; /* celeste pastel suave */
    --color-fondo-bloques: #dbe9f4; /* celeste pastel suave igual años */
    --color-aprobada: #c8f7c5;
    --color-aprobada-tachado: #a4cda3; /* color más apagado para aprobadas tachadas */
    --color-regular: #f8bbd0;
    --color-libre: #e1bee7;
    --color-cursable: #ffe0b2;
    --color-bloqueada: #e0e0e0;

    --color-borde-general: #bbb;
    --color-borde-punteado: #999;
    --color-letra-general: #333;
  }

  body {
    font-family: 'Perfect Penmanship', 'Segoe UI', sans-serif;
    background-color: var(--color-fondo-general);
    color: var(--color-letra-general);
    margin: 0;
    padding: 1rem;
    position: relative;
  }
  h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 1rem;
  }

  /* Botón hamburguesa para panel colores */
  #btn-toggle-panel {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 32px;
    height: 32px;
    cursor: pointer;
    z-index: 9999;
  }
  #btn-toggle-panel span,
  #btn-toggle-panel span::before,
  #btn-toggle-panel span::after {
    display: block;
    background-color: var(--color-letra-general);
    height: 4px;
    border-radius: 2px;
    position: absolute;
    width: 100%;
    transition: 0.3s ease;
  }
  #btn-toggle-panel span {
    position: relative;
    top: 14px;
  }
  #btn-toggle-panel span::before {
    content: '';
    top: -10px;
  }
  #btn-toggle-panel span::after {
    content: '';
    top: 10px;
  }

  /* Panel colores oculto inicialmente */
  #panel-colores {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(0,0,0,0.15);
    padding: 1rem 1.2rem;
    margin-bottom: 1.5rem;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-family: Arial, sans-serif;
    font-size: 0.9rem;
    position: fixed;
    top: 50px;
    right: 10px;
    z-index: 9998;
    background-color: white;
    box-sizing: border-box;
    width: 300px;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid var(--color-borde-general);
    display: none; /* hidden by default */
  }
  #panel-colores.show {
    display: flex;
  }
  #panel-colores label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    flex: 1 1 45%;
    min-width: 140px;
  }
  #panel-colores input[type=color] {
    width: 32px;
    height: 24px;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  /* Malla en flex: años como columnas */
  #malla {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
  }
  .year {
    background-color: var(--color-fondo-anos);
    border-radius: 10px;
    padding: 0.8rem;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    min-width: 240px;
    display: flex;
    flex-direction: column;
    border: 1.5px solid var(--color-borde-general);
  }
  .year h3 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 0.8rem;
  }
  /* Bloques (Anual, Semestres) apilados vertical */
  .bloques {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .bloque {
    background-color: var(--color-fondo-bloques);
    border-radius: 8px;
    padding: 0.5rem 0.6rem;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
    border: 1.2px solid var(--color-borde-general);
  }
  .bloque h4 {
    margin: 0 0 0.5rem 0.5rem;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }
  /* Materias en columnas verticales (filas por materias) */
  .subject {
    background-color: var(--color-libre);
    border-radius: 8px;
    padding: 0.4rem 0.6rem;
    margin: 0.2rem 0.4rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-family: 'Perfect Penmanship', cursive;
    cursor: pointer;
    transition:
      background-color 0.3s ease,
      border-color 0.3s ease,
      color 0.3s ease,
      transform 0.15s ease;
    user-select: none;
    border: 1.5px solid var(--color-borde-general);
    position: relative;
  }
  .subject:focus {
    outline: 3px solid #6ca0dc;
    outline-offset: 2px;
  }
  .subject.estado-aprobada {
    background-color: var(--color-aprobada);
    color: var(--color-letra-general);
    text-decoration: line-through;
    color: #666666;
    background-color: var(--color-aprobada-tachado);
  }
  .subject.estado-regular {
    background-color: var(--color-regular);
  }
  .subject.estado-cursable {
    background-color: var(--color-cursable);
  }
  .subject.estado-libre {
    background-color: var(--color-libre);
  }
  .subject.bloqueada {
    background-color: var(--color-bloqueada);
    cursor: not-allowed;
    color: #777;
    border-style: dotted;
    border-color: var(--color-borde-punteado);
  }
  /* Animación clic */
  .subject.animar {
    animation: clickAnim 0.3s ease forwards;
  }
  @keyframes clickAnim {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  /* Scroll horizontal para malla si no cabe */
  @media (max-width: 768px) {
    #malla {
      flex-wrap: nowrap;
    }
  }
</style>
</head>
<body>

<h2>Malla Curricular - Licenciatura en Psicología</h2>

<!-- Botón hamburguesa para abrir panel colores -->
<button id="btn-toggle-panel" aria-label="Abrir configuración de colores" aria-expanded="false" aria-controls="panel-colores" type="button">
  <span></span>
</button>

<!-- Panel para elegir colores (oculto por defecto) -->
<div id="panel-colores" aria-label="Configuración de colores" role="region" aria-hidden="true">
  <label for="color-fondo-general">Fondo general
    <input type="color" id="color-fondo-general" value="#fffde7" title="Fondo general de la página" />
  </label>
  <label for="color-fondo-anos">Fondo años
    <input type="color" id="color-fondo-anos" value="#dbe9f4" title="Fondo de los años (columnas)" />
  </label>
  <label for="color-fondo-bloques">Fondo bloques
    <input type="color" id="color-fondo-bloques" value="#dbe9f4" title="Fondo de los bloques (Anual, Semestres)" />
  </label>
  <label for="color-aprobada">Estado aprobada
    <input type="color" id="color-aprobada" value="#c8f7c5" title="Color para materias aprobadas" />
  </label>
  <label for="color-aprobada-tachado">Color aprobada tachada
    <input type="color" id="color-aprobada-tachado" value="#a4cda3" title="Color más apagado para materias aprobadas tachadas" />
  </label>
  <label for="color-regular">Estado regular
    <input type="color" id="color-regular" value="#f8bbd0" title="Color para materias regulares" />
  </label>
  <label for="color-cursable">Estado cursable
    <input type="color" id="color-cursable" value="#ffe0b2" title="Color para materias cursables" />
  </label>
  <label for="color-libre">Estado libre
    <input type="color" id="color-libre" value="#e1bee7" title="Color para materias libres" />
  </label>
  <label for="color-bloqueada">Estado bloqueada
    <input type="color" id="color-bloqueada" value="#e0e0e0" title="Color para materias bloqueadas" />
  </label>
  <label for="color-borde-general">Color borde general
    <input type="color" id="color-borde-general" value="#bbb" title="Color del borde general de los recuadros" />
  </label>
  <label for="color-borde-punteado">Color borde punteado
    <input type="color" id="color-borde-punteado" value="#999" title="Color del borde punteado para materias bloqueadas" />
  </label>
  <label for="color-letra-general">Color letra general
    <input type="color" id="color-letra-general" value="#333" title="Color de las letras" />
  </label>
</div>

<!-- Contenedor malla -->
<div id="malla" role="table" aria-label="Malla curricular"></div>

<script>
  const ESTADOS = ['libre', 'cursable', 'regular', 'aprobada'];
  const defaultColors = {
    'color-fondo-general': '#fffde7',
    'color-fondo-anos': '#dbe9f4',
    'color-fondo-bloques': '#dbe9f4',
    'color-aprobada': '#c8f7c5',
    'color-aprobada-tachado': '#a4cda3',
    'color-regular': '#f8bbd0',
    'color-cursable': '#ffe0b2',
    'color-libre': '#e1bee7',
    'color-bloqueada': '#e0e0e0',
    'color-borde-general': '#bbb',
    'color-borde-punteado': '#999',
    'color-letra-general': '#333'
  };

  // Cargar colores guardados o defaults
  function cargarColores() {
    for (const key in defaultColors) {
      const color = localStorage.getItem(key) || defaultColors[key];
      const input = document.getElementById(key);
      if(input) input.value = color;
      document.documentElement.style.setProperty(`--${key.replace('color-', 'color-')}`, color);
    }
  }

  // Guardar y aplicar color
  function cambiarColor(e) {
    const id = e.target.id;
    const val = e.target.value;
    localStorage.setItem(id, val);
    document.documentElement.style.setProperty(`--${id.replace('color-', 'color-')}`, val);
  }

  // Añadir listeners a inputs de color
  function initPanelColores() {
    for (const key in defaultColors) {
      const input = document.getElementById(key);
      if(input) input.addEventListener('input', cambiarColor);
    }
  }

  // Datos materias (sin cambios)
  const materias = {
    "1": {
      "Anual": [
        {nombre: "Filosofía I", clave: "filo1", requisitos: [], regularidad: []},
        {nombre: "Historia de la Psicología", clave: "histpsi", requisitos: [], regularidad: []},
        {nombre: "Metodología de la Investigación en Psicología I", clave: "metod1", requisitos: [], regularidad: []},
        {nombre: "Neuropsicología", clave: "neuro", requisitos: [], regularidad: []}
      ],
      "1º Semestre": [
        {nombre: "Psicología General", clave: "psigral", requisitos: [], regularidad: []},
        {nombre: "Historia del Pensamiento Sociopolítico", clave: "histpol", requisitos: [], regularidad: []}
      ],
      "2º Semestre": [
        {nombre: "Antropología Cultural", clave: "antro", requisitos: ["histpol"], regularidad: ["histpol"]},
        {nombre: "Lingüística", clave: "linguistica", requisitos: [], regularidad: []}
      ]
    },
    "2": {
      "Anual": [
        {nombre: "Estadística (Descriptiva y Muestral)", clave: "estadistica", requisitos: [], regularidad: []},
        {nombre: "Psicología Evolutiva y Cultura (Niño y Adolescente)", clave: "psievol", requisitos: ["psigral"], regularidad: ["psigral"]},
        {nombre: "Psicología Profunda", clave: "psiprof", requisitos: ["psigral"], regularidad: ["psigral"]},
        {nombre: "Teología I", clave: "teo1", requisitos: ["filo1"], regularidad: ["filo1"]}
      ],
      "1º Semestre": [
        {nombre: "Filosofía II", clave: "filo2", requisitos: ["filo1"], regularidad: ["filo1"]},
        {nombre: "Psicolingüística", clave: "psicolinguistica", requisitos: ["linguistica"], regularidad: ["linguistica"]},
        {nombre: "Sociología", clave: "sociologia", requisitos: ["histpsi"], regularidad: ["histpsi"]}
      ],
      "2º Semestre": [
        {nombre: "Antropología Filosófica", clave: "antropfilo", requisitos: ["filo1","filo2"], regularidad: ["filo1","filo2"]},
        {nombre: "Introducción al Psicodiagnóstico", clave: "intropsi", requisitos: ["psigral","neuro"], regularidad: ["psigral","neuro"]},
        {nombre: "Psicología de la Personalidad", clave: "psipersonal", requisitos: ["psigral"], regularidad: ["psigral"]},
        {nombre: "Psicología Experimental", clave: "psiexp", requisitos: ["psigral","metod1"], regularidad: ["psigral","metod1"]}
      ]
    },
    "3": {
      "Anual": [
        {nombre: "Psicología Educacional", clave: "psieduc", requisitos: ["histpsi","psigral","neuro","metod1","psievol"], regularidad: ["psievol"]}
      ],
      "1º Semestre": [
        {nombre: "Psicología del Deporte", clave: "psidep", requisitos: ["psigral","neuro","sociologia","psievol"], regularidad: ["sociologia","psievol"]},
        {nombre: "Psicología Evolutiva y Cultura de Adultez y Senectud", clave: "psievoladulto", requisitos: ["antro","psigral","psievol"], regularidad: ["psievol"]},
        {nombre: "Psicología Social", clave: "psisocial", requisitos: ["histpsi","antro","sociologia","psievol"], regularidad: ["psievol","sociologia"]},
        {nombre: "Psicometría", clave: "psicomet", requisitos: ["metod1","estadistica"], regularidad: ["estadistica"]},
        {nombre: "Psicopatología Infanto Juvenil", clave: "psicopatinf", requisitos: ["psigral","neuro","psievol","psipersonal"], regularidad: ["psigral","neuro","psievol","psipersonal"]},
        {nombre: "Teología II", clave: "teo2", requisitos: ["teo1"], regularidad: ["teo1"]}
      ],
      "2º Semestre": [
        {nombre: "Evaluación Psicológica II", clave: "eval2", requisitos: ["intropsi","psicomet","estadistica"], regularidad: ["estadistica"]},
        {nombre: "Psicología Clínica", clave: "psiclin", requisitos: ["psigral","psiprof","psievol","psipersonal","psisocial"], regularidad: ["psisocial"]},
        {nombre: "Psicología Comunitaria", clave: "psicocom", requisitos: ["psisocial"], regularidad: ["psisocial"]},
        {nombre: "Teología III", clave: "teo3", requisitos: ["teo2"], regularidad: ["teo2"]}
      ]
    },
    "4": {
      "Anual": [
        {nombre: "Prácticas Pre-profesionales", clave: "pracpre", requisitos: ["filo1","histpsi","metod1","neuro","psigral","psievol","psiprof","psipersonal","psicomet","psisocial","psicocom"], regularidad: ["filo1","histpsi","metod1","neuro","psigral","psievol","psiprof","psipersonal","psicomet","psisocial","psicocom"]}
      ],
      "1º Semestre": [
        {nombre: "Psicología Jurídica", clave: "psijuri", requisitos: ["psiclin","psicomet"], regularidad: ["psiclin","psicomet"]}
      ],
      "2º Semestre": [
        {nombre: "Psicología del Trabajo", clave: "psitrab", requisitos: ["psiclin"], regularidad: ["psiclin"]}
      ]
    },
    "5": {
      "Anual": [
        {nombre: "Trabajo Integrador Final", clave: "trabint", requisitos: [], regularidad: []}
      ]
    }
  };

  // Guardar estados materias en localStorage
  function guardarEstados(estados) {
    localStorage.setItem('estadosMaterias', JSON.stringify(estados));
  }
  // Cargar estados materias o crear nuevos
  function cargarEstados() {
    const datos = localStorage.getItem('estadosMaterias');
    if (datos) return JSON.parse(datos);
    else {
      let est = {};
      for (const anio in materias) {
        for (const bloque in materias[anio]) {
          materias[anio][bloque].forEach(m => {
            est[m.clave] = 'libre'; // por defecto todas libres para que puedas elegir libre manualmente
          });
        }
      }
      return est;
    }
  }

  // Comprobar si se aprobaron todas las materias de 4º año
  function todasCuartoAprobadas(estados) {
    let cuarto = materias["4"];
    for (const bloque in cuarto) {
      for (const m of cuarto[bloque]) {
        if(estados[m.clave] !== 'aprobada') return false;
      }
    }
    return true;
  }

  // Comprobar si los requisitos están aprobados o regularizados para cursar
  function puedeCursar(materia, estados) {
    // Para poder cursar, requisitos deben estar al menos en regular o aprobada
    for(const req of materia.requisitos) {
      const est = estados[req];
      if(!(est === 'aprobada' || est === 'regular')) return false;
    }
    return true;
  }

  // Actualizar el estado visible y clases CSS de cada materia
  function actualizarMateriaElemento(elem, estado) {
    elem.classList.remove('estado-libre', 'estado-cursable', 'estado-regular', 'estado-aprobada', 'bloqueada');
    elem.setAttribute('aria-label', elem.dataset.nombre + ' - Estado: ' + estado);
    if(estado === 'libre') elem.classList.add('estado-libre');
    else if(estado === 'cursable') elem.classList.add('estado-cursable');
    else if(estado === 'regular') elem.classList.add('estado-regular');
    else if(estado === 'aprobada') elem.classList.add('estado-aprobada');
  }

  // Actualizar estados y habilitar cursar/ bloqueo según correlativas
  function actualizarEstados(estados) {
    // Primero: calcular cuáles materias pueden cursarse según requisitos aprobados/regularizados
    for (const anio in materias) {
      for (const bloque in materias[anio]) {
        for (const m of materias[anio][bloque]) {
          // obtener el elemento
          const elem = document.querySelector(`[data-clave="${m.clave}"]`);
          if(!elem) continue;

          // Si está aprobado o regular o libre manualmente, dejar como está
          if(estados[m.clave] === 'aprobada') {
            actualizarMateriaElemento(elem, 'aprobada');
            elem.classList.remove('bloqueada');
            elem.setAttribute('tabindex', '0');
            continue;
          }
          if(estados[m.clave] === 'regular') {
            actualizarMateriaElemento(elem, 'regular');
            elem.classList.remove('bloqueada');
            elem.setAttribute('tabindex', '0');
            continue;
          }
          if(estados[m.clave] === 'libre') {
            actualizarMateriaElemento(elem, 'libre');
            elem.classList.remove('bloqueada');
            elem.setAttribute('tabindex', '0');
            continue;
          }

          // Aquí viene la diferencia: puedes marcar manualmente libre, pero también el sistema pone cursable
          // entonces, si el usuario no la marcó libre (u otro), determinamos si es cursable o bloqueada
          // Solo si no está marcada
          if(!ESTADOS.includes(estados[m.clave])) estados[m.clave] = 'libre';

          // Si ya está libre, nada que hacer, ya arriba se mostró libre
          // Pero si está en 'cursable' o ninguno, comprobamos si puede cursar o no
          if(estados[m.clave] !== 'libre') {
            if(puedeCursar(m, estados)) {
              actualizarMateriaElemento(elem, 'cursable');
              elem.classList.remove('bloqueada');
              elem.setAttribute('tabindex', '0');
            } else {
              // Bloqueada por correlativas no cumplidas, pero si estado es libre (manual) no bloqueamos
              if(estados[m.clave] === 'libre') {
                actualizarMateriaElemento(elem, 'libre');
                elem.classList.remove('bloqueada');
                elem.setAttribute('tabindex', '0');
              } else {
                // Si no puede cursar y no está libre, bloqueamos
                actualizarMateriaElemento(elem, 'bloqueada');
                elem.classList.add('bloqueada');
                elem.setAttribute('tabindex', '-1');
              }
            }
          }

          // Caso fallback, si nada de arriba
          if(estados[m.clave] === 'cursable') {
            actualizarMateriaElemento(elem, 'cursable');
            elem.classList.remove('bloqueada');
            elem.setAttribute('tabindex', '0');
          }
        }
      }
    }

    // Condición especial para Trabajo Integrador Final
    const trabInt = document.querySelector(`[data-clave="trabint"]`);
    if(trabInt) {
      if(todasCuartoAprobadas(estados)) {
        // habilitar
        if(estados["trabint"] !== 'aprobada' && estados["trabint"] !== 'regular') {
          estados["trabint"] = 'cursable';
        }
        actualizarMateriaElemento(trabInt, estados["trabint"]);
        trabInt.classList.remove('bloqueada');
        trabInt.setAttribute('tabindex', '0');
      } else {
        // bloquear
        actualizarMateriaElemento(trabInt, 'bloqueada');
        trabInt.classList.add('bloqueada');
        trabInt.setAttribute('tabindex', '-1');
      }
    }
  }

  // Crear y mostrar la malla en el DOM
  function crearMalla(estados) {
    const contenedor = document.getElementById('malla');
    contenedor.innerHTML = '';

    for(const anio of Object.keys(materias).sort()) {
      const yearDiv = document.createElement('div');
      yearDiv.classList.add('year');
      yearDiv.setAttribute('role', 'columnheader');
      yearDiv.setAttribute('aria-label', `${anio} año`);

      const h3 = document.createElement('h3');
      h3.textContent = `${anio}º Año`;
      yearDiv.appendChild(h3);

      const bloquesCont = document.createElement('div');
      bloquesCont.classList.add('bloques');
      yearDiv.appendChild(bloquesCont);

      for(const bloque of ['Anual', '1º Semestre', '2º Semestre']) {
        if(!materias[anio][bloque]) continue;

        const bloqueDiv = document.createElement('div');
        bloqueDiv.classList.add('bloque');
        bloqueDiv.setAttribute('role', 'rowgroup');

        const h4 = document.createElement('h4');
        h4.textContent = bloque;
        bloqueDiv.appendChild(h4);

        for(const mat of materias[anio][bloque]) {
          const subj = document.createElement('div');
          subj.classList.add('subject');
          subj.setAttribute('tabindex', '0');
          subj.dataset.clave = mat.clave;
          subj.dataset.nombre = mat.nombre;
          subj.title = `${mat.nombre} (${anio}º Año - ${bloque})`;
          subj.textContent = mat.nombre;

          // Estado inicial: si está guardado, lo pone
          const est = estados[mat.clave] || 'libre';

          actualizarMateriaElemento(subj, est);

          bloqueDiv.appendChild(subj);
        }

        bloquesCont.appendChild(bloqueDiv);
      }

      contenedor.appendChild(yearDiv);
    }
  }

  // Cambiar estado cuando se hace clic en una materia
  function toggleEstadoMateria(clave, estados) {
    const current = estados[clave];
    // Estados en ciclo: libre -> cursable -> regular -> aprobada -> libre
    let idx = ESTADOS.indexOf(current);
    if(idx === -1) idx = 0;
    let siguiente = ESTADOS[(idx + 1) % ESTADOS.length];
    estados[clave] = siguiente;
  }

  // Manejo del clic en materias
  function clickMateria(e, estados) {
    const elem = e.currentTarget;
    const clave = elem.dataset.clave;

    // Si está bloqueada y no es libre, no permitir cambiar estados (excepto que manualmente quieras poner libre)
    if(elem.classList.contains('bloqueada') && estados[clave] !== 'libre') {
      // No cambia estado
      return;
    }

    toggleEstadoMateria(clave, estados);

    // Si el nuevo estado es 'libre' se acepta sin problema aunque la correlativa no se cumpla
    // Por eso no bloquea

    guardarEstados(estados);
    actualizarEstados(estados);
    // Animación de clic
    elem.classList.add('animar');
    setTimeout(() => elem.classList.remove('animar'), 350);
  }

  // Manejo teclado (enter o space) para cambiar estados
  function keyDownMateria(e, estados) {
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      clickMateria(e, estados);
    }
  }

  // Inicialización total
  function init() {
    cargarColores();
    initPanelColores();

    const estados = cargarEstados();

    crearMalla(estados);
    actualizarEstados(estados);

    // Añadir eventos clic y teclado a materias
    document.querySelectorAll('.subject').forEach(elem => {
      elem.addEventListener('click', e => clickMateria(e, estados));
      elem.addEventListener('keydown', e => keyDownMateria(e, estados));
    });

    // Botón hamburguesa para mostrar/ocultar panel colores
    const btnPanel = document.getElementById('btn-toggle-panel');
    const panel = document.getElementById('panel-colores');
    btnPanel.addEventListener('click', () => {
      const visible = panel.classList.toggle('show');
      btnPanel.setAttribute('aria-expanded', visible);
      panel.setAttribute('aria-hidden', !visible);
    });
  }

  window.addEventListener('load', init);
</script>

</body>
</html>
